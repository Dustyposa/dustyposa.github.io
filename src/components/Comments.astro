---
// src/components/Comments.astro
// 最终解决方案：在暗黑模式下，为评论区提供一个浅色背景，以确保 Giscus 的可读性。
---
<div class="comments-wrapper">
  <section id="giscus-container">
    <h3>评论区</h3>
    <div id="giscus-comments">
      <!-- Giscus 脚本将通过下面的客户端脚本动态注入 -->
    </div>
  </section>
</div>

<style>
  .comments-wrapper {
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    max-width: 100ch;
    margin-top: 3rem;
  }

  /* 在暗黑模式下，为评论区容器设置浅色背景 */
  html.dark .comments-wrapper {
    background-color: #f8f9fa; /* 一个非常浅的灰色 */
    border-radius: 12px;
    padding: 1.5rem 2rem;
  }

  #giscus-container {
    margin-top: 0;
    padding-top: 0;
    border-top: none;
  }

  #giscus-container h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 2rem;
    color: var(--color-text); /* 默认文字颜色 */
  }

  /* 在暗黑模式下，强制标题为深色，以在浅色背景上显示 */
  html.dark #giscus-container h3 {
    color: #111827; /* 一个深灰色 */
  }
</style>

<script>
  // 此脚本会动态加载 Giscus
  const giscusContainer = document.querySelector("#giscus-comments");
  const GISCUS_THEME = "light"; // 最终修正：始终使用 'light' 主题，因为我们自己控制背景

  function loadGiscus() {
    if (!giscusContainer) return;
    giscusContainer.innerHTML = ''; // 加载前清空容器

    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.crossOrigin = "anonymous";

    // --- ⚠️ 重要：配置已根据您提供的信息更新 ---
    script.setAttribute("data-repo", "dustyposa/dustyposa.github.io");
    script.setAttribute("data-repo-id", "MDEwOlJlcG9zaXRvcnkyNTMzNzY4OTE=");
    script.setAttribute("data-category", "Comments");
    script.setAttribute("data-category-id", "DIC_kwDODxo5e84Csrik");
    // --- Giscus 配置结束 ---

    script.setAttribute("data-mapping", "pathname");
    script.setAttribute("data-strict", "0");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "0");
    script.setAttribute("data-input-position", "bottom");
    script.setAttribute("data-lang", "zh-CN");
    script.setAttribute("data-theme", GISCUS_THEME);

    giscusContainer.appendChild(script);
  }

  // 首次加载页面时，加载 Giscus
  loadGiscus();

  // 当 Astro 的视图过渡（View Transitions）切换页面后，重新加载 Giscus
  document.addEventListener("astro:after-swap", loadGiscus);

  // 由于我们现在强制使用 light 主题，不再需要 MutationObserver 来监听主题切换了。
  // 这简化了代码并避免了之前可能出现的时序问题。
</script>