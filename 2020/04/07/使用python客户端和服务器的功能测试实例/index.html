<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" type="image/png" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="ä¸€äº›ç»éªŒçš„è®°å½•ã€‚"><meta name="author" content="Dusty Posa"><meta name="keywords" content="python,python3,process,script"><title>ä½¿ç”¨pythonå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åŠŸèƒ½æµ‹è¯•å®ä¾‹ - Posaã®ã«ã‚</title><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css"><link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"><link rel="stylesheet" href="/css/main.css"><link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Posaã®ã«ã‚</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/">é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/">å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/">åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/">æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/">å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2" id="background" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask rgba-black-light flex-center"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><p class="mt-3 post-meta"><i class="fas fa-calendar-alt" aria-hidden="true"></i> æ˜ŸæœŸäºŒ, å››æœˆ 7æ—¥ 2020, 10:01 ä¸Šåˆ</p><p class="mt-1"><span class="post-meta"><i class="far fa-chart-bar"></i> 2.7k å­— </span><span class="post-meta"><i class="far fa-clock"></i> 11 åˆ†é’Ÿ</span></p></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5 z-depth-3" id="board"><div class="post-content mx-auto" id="post"><p class="note note-warning">æœ¬æ–‡æœ€åæ›´æ–°äºï¼šæ˜ŸæœŸä¸€, å››æœˆ 13æ—¥ 2020, 6:02 æ—©ä¸Š</p><div class="markdown-body"><blockquote><h3 id="ç¼–å†™åŠŸèƒ½æµ‹è¯•çš„ç›®çš„"><a href="#ç¼–å†™åŠŸèƒ½æµ‹è¯•çš„ç›®çš„" class="headerlink" title="ç¼–å†™åŠŸèƒ½æµ‹è¯•çš„ç›®çš„"></a>ç¼–å†™åŠŸèƒ½æµ‹è¯•çš„ç›®çš„</h3><p>éªŒè¯åº”ç”¨çš„è¡Œä¸ºå’ŒæœŸæœ›ä¸€è‡´çš„æµ‹è¯•<br>ç¡®è®¤å¼‚å¸¸ä¿®å¤çš„æµ‹è¯•ï¼ˆå¢åŠ æµ‹è¯•è¦†ç›–ç‡ï¼‰<br>æƒ³æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œå› ä¸ºæ¥å£éœ€è¦å¢åŠ ä¸€äº›åŠŸèƒ½ï¼Œè€Œæ›´æ”¹äº†ä¸€äº›ä»£ç ã€‚<br>é‚£ä¹ˆä¿®æ”¹çš„ä»£ç ä¼šä¸ä¼šå¯¹ä¹‹å‰çš„åŠŸèƒ½æœ‰å½±å“å‘¢ï¼Ÿæµ‹è¯•å°±æ¥äº†ã€‚<br><strong>å¹¶ä¸”ï¼Œè‰¯å¥½çš„ç¼–å†™æµ‹è¯•ä¹ æƒ¯ï¼ŒæŒç»­åœ°å†™æµ‹è¯•å†™æ–‡æ¡£å†™ä»£ç æ˜¯å¿…å¤‡çš„ã€‚æ›´æ”¹ä»£ç ä¹Ÿæ›´åŠ æ–¹ä¾¿ï¼ˆé‡æ„ï¼‰ï¼Œåªç”¨ç›¸åŒçš„æµ‹è¯•ä»£ç å³å¯ã€‚è€Œä¸”è¿˜èƒ½æå‡ä»£ç çš„å¯è¯»æ€§ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ˜¯åŠŸèƒ½çš„æè¿°ã€‚</strong></p></blockquote><h4 id="æµ‹è¯•çš„åˆ†ç±»"><a href="#æµ‹è¯•çš„åˆ†ç±»" class="headerlink" title="æµ‹è¯•çš„åˆ†ç±»"></a>æµ‹è¯•çš„åˆ†ç±»</h4><ol><li>å•å…ƒæµ‹è¯•ï¼ˆunit testï¼‰# ä¸»è¦æµ‹å‡½æ•°</li><li>åŠŸèƒ½æµ‹è¯•ï¼ˆfunction testï¼‰# ä¸»è¦æµ‹æŸäº›ä»£ç æ®µå®Œæ•´çš„åŠŸèƒ½</li><li>é›†æˆæµ‹è¯•ï¼ˆintegration testï¼‰ # ä¸»è¦åœ¨çº¿ä¸Šç¯å¢ƒæµ‹è¯•</li><li>è´Ÿè½½/å‹åŠ›æµ‹è¯• ï¼ˆload testï¼‰ # å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰</li><li>ç«¯åˆ°ç«¯æµ‹è¯• ï¼ˆend-to-end testï¼‰ # å®Œæ•´çš„æµ‹è¯•äº§å“</li></ol><p>æœ¬æ–‡ä¸»è¦è®²è§£åŠŸèƒ½æµ‹è¯•å®ä¾‹çš„ç¼–å†™ã€‚</p><h2 id="åœ¨pythonä¸­ç¼–å†™åŠŸèƒ½æµ‹è¯•ä»£ç "><a href="#åœ¨pythonä¸­ç¼–å†™åŠŸèƒ½æµ‹è¯•ä»£ç " class="headerlink" title="åœ¨pythonä¸­ç¼–å†™åŠŸèƒ½æµ‹è¯•ä»£ç "></a>åœ¨pythonä¸­ç¼–å†™åŠŸèƒ½æµ‹è¯•ä»£ç </h2><p>ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå®¢æˆ·ç«¯æµ‹è¯•å’ŒæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚<br>ç›®çš„éƒ½æ˜¯ä¸ºäº†æ£€æµ‹è‡ªå·±å†™çš„ä»£ç æ˜¯å¦å®ç°äº†è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ã€‚</p><blockquote><p>åŠŸèƒ½æµ‹è¯•ç»„è¦æ³¨æ„çš„ç‚¹ï¼š<br><strong>åŠŸèƒ½æµ‹è¯•éƒ½ä¸å ç”¨ç½‘ç»œæœåŠ¡èµ„æºï¼Œè¯·æ±‚éƒ½ç›´æ¥æ¨¡æ‹Ÿç½‘ç»œèµ„æº</strong></p></blockquote><p><strong>å®¢æˆ·ç«¯æµ‹è¯•å¯ä»¥ç”¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ</strong></p><blockquote><p>å¸¦æœ‰è¯·æ±‚çš„åœ°æ–¹éƒ½å¯ä»¥:<br><strong>çˆ¬è™«</strong><br><strong>è°ƒç”¨ç¬¬ä¸‰æ–¹çš„æ¥å£</strong>ï¼ˆOSSï¼Œ æ•°æ®åº“ï¼Œ AIæœåŠ¡ç­‰ï¼‰</p></blockquote><p>PS: ä¸ºäº†æå‡ä»£ç è´¨é‡ï¼Œæ‰€æœ‰ä»£ç éƒ½ä¼šä½¿ç”¨é™æ€æ³¨é‡Š,ä½ çš„<code>python version</code> éœ€è¦ &gt;= 3.5<br><strong>å¦‚ä½•å®ç°ç½‘ç»œèµ„æºè¯·æ±‚çš„æ¨¡æ‹Ÿå‘¢ï¼Ÿè¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„ mock å°±è¦å‡ºåœºäº†ã€‚</strong></p><h3 id="1-å®¢æˆ·ç«¯æµ‹è¯•-request-mock"><a href="#1-å®¢æˆ·ç«¯æµ‹è¯•-request-mock" class="headerlink" title="1. å®¢æˆ·ç«¯æµ‹è¯• request_mock"></a>1. å®¢æˆ·ç«¯æµ‹è¯• request_mock</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„å®¢æˆ·ç«¯ï¼Œå½“ä½œæˆ‘ä»¬ç”¨æ¥æµ‹è¯•çš„å®¢æˆ·ç«¯ <code>client.py</code>ï¼Œä»£ç å¦‚ä¸‹:</p><pre><code class="python">import typing
from urllib import parse

import requests


MyResponse = typing.Dict[str, typing.List[str]]


class MySpider:
    &quot;&quot;&quot;æ‹¼æ¥è¿”å›çš„id&quot;&quot;&quot;
    def __init__(self, url=&quot;http://example.com&quot;) -&gt; None:
        self.url: str = url
        self.return_base_url: str = &quot;http://shop.com/id/&quot;

    def get_data(self):
        try:
            response: requests.Response = requests.get(self.url)
        except requests.exceptions.ConnectionError:
            # é“¾æ¥è¶…æ—¶
            return self._handle_data()
        else:
            response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚çŠ¶æ€å€¼200
        data = response.json()
        return self._handle_data(data)

    def _handle_data(self, data=None) -&gt; MyResponse:
        &quot;&quot;&quot;å¤„ç†è¯·æ±‚çš„æ•°æ®&quot;&quot;&quot;
        if data:
            return_data: typing.List[str] = []
            all_id = data.get(&quot;all_id&quot;, [])
            for goods_id in all_id:
                return_data.append(parse.urljoin(self.return_base_url, goods_id))
            return {&quot;data&quot;: return_data}
        return {&quot;data&quot;: []}
</code></pre><p>å®¢æˆ·ç«¯ç®€å•çš„å®ç°äº†ä¸€ä¸ªè¯·æ±‚ç½‘ç«™å¹¶å¤„ç†è¿”å›æ•°æ®çš„é€»è¾‘.<br>é‚£ä¹ˆï¼Œå¼€å§‹æµ‹è¯•æˆ‘ä»¬çš„å®¢æˆ·ç«¯å§ï¼<br>è®°ä½ï¼š<strong>è¿™æ˜¯åŠŸèƒ½æµ‹è¯•ï¼Œä¸ç½‘ç»œèµ„æºè®¿é—®æ— å…³ï¼Œæˆ‘ä»¬åªéœ€è¦æµ‹è¯•åŠŸèƒ½é€»è¾‘ï¼å…¶ä½™ç¬¬ä¸‰æ–¹å¯¹è±¡ç”¨æ¨¡æ‹Ÿå¯¹è±¡å³å¯ï¼</strong><br>ä¸€èˆ¬çš„å¯¹è±¡ï¼Œ<code>unittest</code> è‡ªå¸¦çš„ <code>mock</code> å¯¹è±¡å°±èƒ½æ»¡è¶³ã€‚é‚£ä¹ˆå¦‚ä½•ç½‘ç»œæ¨¡æ‹Ÿå¯¹è±¡çš„å®ç°å‘¢ï¼Ÿè¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„ <code>requests_mock</code> å°±è¦ç™»åœºäº†ã€‚<br>å®ƒä¼šå®ç°å¯¹è¯·æ±‚çš„æ‹¦æˆªï¼Œä»¥æ­¤è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚<br>æµ‹è¯•ä»£ç  <code>test_client.py</code> å¦‚ä¸‹:</p><pre><code class="python">import unittest
from unittest import mock

import requests
import requests_mock

from client import MySpider, MyResponse


class TestMySpider(unittest.TestCase):
    def setUp(self) -&gt; None:
        self.spider: MySpider = MySpider()  # åˆå§‹åŒ–å¯¹è±¡ï¼Œé¦–å…ˆè¿è¡Œè¿™é‡Œï¼Œå†è¿è¡Œ test_xxxxxx

    def test_handle_data(self) -&gt; None:
        &quot;&quot;&quot;æµ‹è¯•å¤„ç†ä»£ç çš„é€»è¾‘&quot;&quot;&quot;
        return_data: MyResponse = {&quot;data&quot;: []}  # è¿”å›çš„åŸºç¡€æ•°æ®
        self.assertEqual(self.spider._handle_data(), return_data)  # noneå€¼è¿”å›ï¼Œæµ‹è¯•æ˜¯å¦ç›¸ç­‰

        return_data.update(data=[
            &quot;http://shop.com/id/23&quot;,
            &quot;http://shop.com/id/32&quot;
        ])  # ç”Ÿæˆæ­£å¸¸å€¼
        # æ­£å¸¸å€¼è¿”å›, æµ‹è¯•æ˜¯å¦ç›¸ç­‰
        self.assertEqual(self.spider._handle_data({&quot;all_id&quot;: [&quot;23&quot;, &quot;32&quot;]}), return_data)

    @requests_mock.mock()
    def test_get_data(self, mocker) -&gt; None:
        &quot;&quot;&quot;æµ‹è¯•æ­£å¸¸é€»è¾‘&quot;&quot;&quot;
        shop_data: MyResponse = {&quot;all_id&quot;: [&quot;12&quot;, &quot;123&quot;, &quot;1234&quot;]}
        mocker.get(requests_mock.ANY, json=shop_data)  # æˆªèƒ¡ requests.get

        spider_data: MyResponse = self.spider.get_data()  # è·å–æ­£å¸¸è¿”å›å€¼
        response_data: MyResponse = {&#39;data&#39;: [&#39;http://shop.com/id/12&#39;, &#39;http://shop.com/id/123&#39;, &#39;http://shop.com/id/1234&#39;]}
        self.assertEqual(spider_data, response_data)  # æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰

        shop_data: MyResponse = {}
        mocker.get(requests_mock.ANY, json=shop_data)  # æˆªèƒ¡ requests.get
        spider_data: MyResponse = self.spider.get_data()  # è·å–ç©ºè¿”å›å€¼
        response_data: MyResponse = {&#39;data&#39;: []}
        self.assertEqual(spider_data, response_data)  # æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰

    @mock.patch.object(requests, &quot;get&quot;, side_effect=requests.ConnectionError(&quot;No network&quot;))
    def test_net_error(self, mocked) -&gt; None:
        return_data: MyResponse = {&quot;data&quot;: []}
        spider_data: MyResponse = self.spider.get_data()  # è·å–ç½‘ç»œé”™è¯¯çš„è¿”å›å€¼
        self.assertEqual(spider_data, return_data)


if __name__ == &#39;__main__&#39;:
    unittest.main()</code></pre><p>æˆ‘ä»¬è¿è¡Œä¸€ä¸‹å°±èƒ½çœ‹åˆ°æµ‹è¯•çš„ç»“æœã€‚<br>æ•´ä¸ªæµ‹è¯•ä»£ç æ•´ä½“ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œ<br><code>requests_mock</code> ä½œä¸ºä¸€ä¸ªè£…é¥°å™¨ï¼Œ<code>reqeusts</code>è¿›è¡Œäº†æ‹¦æˆªã€‚ä¹‹åå°±ç›´æ¥è¿›è¡Œäº†è®¾å®šå€¼çš„è¿”å›ã€‚<br>éœ€è¦æ³¨æ„çš„å‡ ä¸ªå‡½æ•°:</p><ol><li><code>unittest</code> ä¸º python æ ‡å‡†åº“ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥å¹¶ä½¿ç”¨ï¼Œä¸è¿‡åç»­çš„æ–‡ç« æˆ‘ä»¬ä¼šå‡çº§æˆ <code>pytest</code> , å¯å®šåˆ¶æ€§æ›´å¼ºã€‚</li><li>å®‰è£… <code>requests_mock</code> , ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›´æ¥ <code>pip install reqeusts_mock</code> å³å¯ï¼Œåç»­æˆ‘ä»¬ä¼šè¿›è¡Œ <code>requests_mock</code> çš„æºç åˆ†æã€‚å¹¶ä¸”ï¼Œ<code>reqeusts_mock</code> çš„æºç å¯¹äºå­¦ä¹ é™æ€æ³¨é‡Šä¹Ÿæ˜¯æå¥½çš„ã€‚</li><li><code>@unittest.mock.patch.object</code> æ˜¯è¿›è¡Œå¯¹è±¡å±‚é¢çš„å¼‚å¸¸çŠ¶æ€æŠ›å‡ºï¼Œå½“ <code>requests</code> å¯¹è±¡è°ƒç”¨ <code>get</code> æ–¹æ³•æ—¶ï¼Œä¾¿æŠ›å‡ºé”™è¯¯ã€‚<h3 id="2-æµ‹è¯•æœåŠ¡å™¨ç«¯"><a href="#2-æµ‹è¯•æœåŠ¡å™¨ç«¯" class="headerlink" title="2. æµ‹è¯•æœåŠ¡å™¨ç«¯"></a>2. æµ‹è¯•æœåŠ¡å™¨ç«¯</h3>å…¶å®å®¢æˆ·ç«¯çš„æµ‹è¯•æ¯”æœåŠ¡å™¨ç«¯éš¾ä¸€äº›ã€‚<blockquote><p>å› ä¸ºæœåŠ¡å™¨ç«¯çš„æµ‹è¯•ï¼Œæ¡†æ¶å·²ç»å¸®ä½ å°è£…å¥½äº†ï¼<br><strong>æœåŠ¡ç«¯åŠŸèƒ½æµ‹è¯•ç”¨åœ¨å“ªï¼Ÿå½“ç„¶æ˜¯æµ‹è‡ªå·±å†™çš„æ¥å£å•¦ï¼</strong></p></blockquote></li></ol><p>æµ‹è¯•æ­¥éª¤ç±»ä¼¼ï¼Œç¼–å†™æœåŠ¡å™¨ï¼Œæˆ‘ä»¬ç”¨ <code>flask</code> å’Œ <code>starlette</code> è¿›è¡Œä¸¾ä¾‹ï¼Œåˆ†åˆ«ä»£è¡¨<code>python</code> åŒæ­¥webæ¡†æ¶å’Œå¼‚æ­¥webæ¡†æ¶ã€‚</p><h4 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h4><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„<code>flask_server.py</code>, ä»£ç å¦‚ä¸‹:</p><pre><code class="python">from flask import Flask, jsonify

app = Flask(__name__)


@app.route(&#39;/api&#39;, methods=[&quot;GET&quot;])
def msg_api():
    &quot;&quot;&quot;å¸¸è§„è¿”å›&quot;&quot;&quot;
    return jsonify({&#39;Hello&#39;: &#39;World!&#39;})


@app.route(&#39;/goods/&lt;int:goods_id&gt;&#39;, methods=[&quot;GET&quot;])
def query_goods(goods_id):
    &quot;&quot;&quot;å¸¦idçš„è·¯ç”±&quot;&quot;&quot;
    return jsonify({&quot;name&quot;: &quot;cake&quot;, &quot;id&quot;: goods_id})


@app.errorhandler(404)
def error_404_handing(error):
    &quot;&quot;&quot;404é¡µé¢&quot;&quot;&quot;
    return jsonify({&quot;msg&quot;: &quot;no route&quot;, &quot;err&quot;: str(error)}), 404


if __name__ == &#39;__main__&#39;:
    app.run()
</code></pre><p>ä»£è¡¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæœ‰3ä¸ªè·¯ç”±</p><ol><li>å¸¸è§„è¿”å›çš„è·¯ç”± <code>/api</code></li><li>è·¯ç”±å¸¦id <code>/goods/123123</code></li><li>404 é¡µé¢<br>æµ‹è¯•ä»£ç <code>test_flask_client.py</code> ä»£ç å¦‚ä¸‹:<pre><code class="python">import json
import typing
import unittest
</code></pre></li></ol><p>from flask_basic import app as my_app</p><p>class TestApp(unittest.TestCase):</p><pre><code>def setUp(self) -&gt; None:
    self.client = my_app.test_client()  # åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œapp è‡ªå¸¦çš„æµ‹è¯•å®¢æˆ·ç«¯

def test_msg_api(self) -&gt; None:
    response = self.client.get(&quot;/api&quot;)  # è®¿é—®è·¯ç”±
    data: typing.Dict[str, typing.Any] = json.loads(response.data.decode(&quot;u8&quot;))  # å“åº”æ•°æ®æ ¼å¼åŒ–
    self.assertEqual(data[&quot;Hello&quot;], &quot;World!&quot;)  # åˆ¤æ–­ç»“æœ

def test_goods_api(self) -&gt; None:
    response = self.client.get(&quot;/goods/123&quot;)  # è®¿é—®è·¯ç”±
    data: typing.Dict[str, typing.Any] = json.loads(response.data.decode(&quot;u8&quot;))  # å“åº”æ•°æ®æ ¼å¼åŒ–
    self.assertEqual(data[&quot;name&quot;], &quot;cake&quot;)  # åˆ¤æ–­ç»“æœ
    self.assertEqual(data[&quot;id&quot;], 123)  # åˆ¤æ–­ç»“æœ

def test_404_page(self) -&gt; None:
    response = self.client.get(&quot;/idontknow&quot;)  # è®¿é—®è·¯ç”±
    self.assertEqual(response.status, &quot;404 NOT FOUND&quot;)  # 404 çŠ¶æ€ç›‘æµ‹
    data: typing.Dict[str, typing.Any] = json.loads(response.data.decode(&quot;u8&quot;))  # å“åº”æ•°æ®æ ¼å¼åŒ–
    self.assertEqual(data[&quot;msg&quot;], &quot;no route&quot;)  # è¿”å›æ•°æ®ç›‘æµ‹</code></pre><p>if <strong>name</strong> == â€˜<strong>main</strong>â€˜:<br>unittest.main()</p><pre><code>æ•´ä¸ªä»£ç ä¹Ÿå°±å¾ˆç®€å•æ¸…æ™°äº†ï¼Œå› ä¸º`flask` è‡ªå¸¦çš„`app`å°±åŒ…å«äº†æµ‹è¯•å®¢æˆ·ç«¯ï¼Œåªéœ€è¦è¯·æ±‚æ£€æŸ¥å“åº”å³å¯ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥ä¸€æ°”å‘µæˆï¼
#### starletee
æˆ‘ä»¬ç¼–å†™ `starletee` çš„æœåŠ¡å™¨æ–‡ä»¶ `starletee_server.py`,ä»£ç å¦‚ä¸‹:
```python
from starlette.applications import Starlette
from starlette.responses import JSONResponse

app = Starlette()


@app.route(&#39;/api&#39;, methods=[&quot;GET&quot;])
async def hello_api(request) -&gt; JSONResponse:
    &quot;&quot;&quot;å¸¸è§„è¿”å›&quot;&quot;&quot;
    return JSONResponse({&#39;Hello&#39;: &#39;World!&#39;})


@app.route(&#39;/goods/{goods_id:int}&#39;, methods=[&quot;GET&quot;])
async def query_goods(request) -&gt; JSONResponse:
    &quot;&quot;&quot;å¸¦idçš„è·¯ç”±&quot;&quot;&quot;
    return JSONResponse({&quot;name&quot;: &quot;cake&quot;, &quot;id&quot;: request.path_params.get(&quot;goods_id&quot;)})


@app.exception_handler(404)
async def not_found(request, exc) -&gt; JSONResponse:
    &quot;&quot;&quot;404å¤„ç†&quot;&quot;&quot;
    return JSONResponse(content={&quot;msg&quot;: &quot;no route&quot;}, status_code=exc.status_code)</code></pre><p><code>starletee</code>æ•´ä½“ä»£ç å’Œ<code>flask</code>å¾ˆç›¸ä¼¼ï¼Œæ‰€ä»¥é‡åˆ°æ–°çš„æ¡†æ¶ä¸è¦ç•æƒ§ï¼Œå¤§ä½“å…¶å®æ˜¯å·®ä¸å¤šçš„ï¼Œåªæœ‰ä¸€äº›å°ç»†èŠ‚ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼š</p><ol><li><code>flask</code> çš„ <code>request</code>å¯¹è±¡æ˜¯å…¨å±€çš„ï¼Œè€Œ <code>starletee</code>çš„ <code>request</code>å¯¹è±¡å’Œ<code>django</code>çš„ <code>request</code>å¯¹è±¡ç›¸ä¼¼ï¼Œéƒ½æ˜¯åœ¨åˆ†å‘åœ¨è·¯ç”±ä¸­ã€‚</li><li>è·¯ç”±ä¸­çš„å˜é‡è·å–æ–¹å¼ä¸åŒï¼Œä¸€ä¸ªå­˜åœ¨å‚æ•°ä¸­ï¼Œä¸€ä¸ªå­˜åœ¨è¯·æ±‚å¯¹è±¡ä¸­ã€‚</li><li>é”™è¯¯çŠ¶æ€ç å¤„ç†æ–¹å¼è¿”å›æ•°æ®æ ¼å¼ä¸åŒã€‚</li></ol><p>ä¸‹é¢ä¸ºæµ‹è¯•<code>starletee</code>çš„ä»£ç <code>test_starletee_api.py</code>:</p><pre><code class="python">import typing
import unittest

from starlette.testclient import TestClient

from starletee_server import app as my_app


class TestApp(unittest.TestCase):

    def setUp(self) -&gt; None:
        self.client = TestClient(my_app)  # åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œapp è‡ªå¸¦çš„æµ‹è¯•å®¢æˆ·ç«¯

    def test_msg_api(self) -&gt; None:
        response = self.client.get(&quot;/api&quot;)  # è®¿é—®è·¯ç”±
        data: typing.Dict[str, typing.Any] = response.json()  # å“åº”æ•°æ®æ ¼å¼åŒ–
        self.assertEqual(data[&quot;Hello&quot;], &quot;World!&quot;)  # åˆ¤æ–­ç»“æœ

    def test_goods_api(self) -&gt; None:
        response = self.client.get(&quot;/goods/123&quot;)  # è®¿é—®è·¯ç”±
        data: typing.Dict[str, typing.Any] = response.json()  # å“åº”æ•°æ®æ ¼å¼åŒ–
        self.assertEqual(data[&quot;name&quot;], &quot;cake&quot;)  # åˆ¤æ–­ç»“æœ
        self.assertEqual(data[&quot;id&quot;], 123)  # åˆ¤æ–­ç»“æœ

    def test_404_page(self) -&gt; None:
        response = self.client.get(&quot;/idontknow&quot;)  # è®¿é—®è·¯ç”±
        self.assertEqual(response.status_code, 404)  # 404 çŠ¶æ€ç›‘æµ‹
        data: typing.Dict[str, typing.Any] = response.json()  # å“åº”æ•°æ®æ ¼å¼åŒ–
        self.assertEqual(data[&quot;msg&quot;], &quot;no route&quot;)  # è¿”å›æ•°æ®ç›‘æµ‹


if __name__ == &#39;__main__&#39;:
    unittest.main()</code></pre><p>é™¤äº†å“åº”æ•°æ®çš„è§£ææ–¹å¼ä¸åŒå¤–ï¼Œå…¶ä»–éƒ½ä¸€æ¨¡ä¸€æ ·ã€‚<br>å¯¹äº†ï¼Œæœ‰ä¸€ç‚¹ä¸ä¸€æ ·ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„åˆå§‹åŒ–ä¸ä¸€æ ·ã€‚<code>TestClient(my_app)</code><br>å½“ç„¶ï¼Œè¿™åªæ˜¯ç¤ºä¾‹ï¼Œç”¨çš„è‡ªå¸¦çš„<code>TestClien</code>,å¹¶ä¸”æ˜æ˜¾æ¯”<code>flask</code>è‡ªå¸¦çš„å¥½ç”¨ã€‚ä¹‹åçš„æ–‡ç« æˆ‘ä»¬ä¼šè®²è§£ <code>WebTest</code>è¿™ä¸ªä¸“é—¨è®¾è®¡æ¥ä½œä¸ºæµ‹è¯•å®¢æˆ·ç«¯ï¼ˆ<code>flask</code>ä¸­æœ‰ <code>flask_webtest</code>ï¼‰</p><h3 id="3-æ€»ç»“"><a href="#3-æ€»ç»“" class="headerlink" title="3.æ€»ç»“"></a>3.æ€»ç»“</h3><p>æœåŠ¡å™¨çš„åŠŸèƒ½æµ‹è¯•å…¶å®å¾ˆç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæµ‹è¯•ä»£ç å‡ ä¹ä¸ç”¨æ›´æ”¹å°±èƒ½ä½¿ç”¨ï¼Œé‚£æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œè¿™æ ·æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ<br>dangdangdangï¼Œç­”æ¡ˆå°±æ˜¯ï¼š<br><strong>åœ¨å†™æµ‹è¯•demoæ—¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ›´æ¢æ¡†æ¶æ¥ç»§ç»­è¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸ç”¨æ›´æ”¹æµ‹è¯•ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰æ‹©æœ€é€‚åˆå½“å‰ä¸šåŠ¡çš„æ¡†æ¶æ¥ä½¿ç”¨ï¼ï¼ˆç‰¹åˆ«å¯¹äºå¾®æœåŠ¡æ¥è¯´ï¼Œé’ˆå¯¹å½“å‰ä¸šåŠ¡ï¼Œé€‰æ‹©æœ€åˆé€‚çš„åç«¯ã€‚ï¼‰</strong></p><p><strong>pythonå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åŠŸèƒ½æµ‹è¯•æµç¨‹å¤§é¢˜å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦è®°ä½ä»¥ä¸‹å‡ ä¸ªè¦ç‚¹ï¼š</strong></p><ol><li>åŠŸèƒ½æµ‹è¯•ï¼ˆåŠå•å…ƒæµ‹è¯•ï¼‰ä¸ä¾èµ–ç½‘ç»œèµ„æºï¼ŒIOç­‰ï¼Œä¸€èˆ¬ä½¿ç”¨<code>MOCK</code>å¯¹è±¡æ¥æ¨¡æ‹Ÿè¿”å›æ•°æ®ã€‚</li><li>å®¢æˆ·ç«¯è¯·æ±‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>requests_mock</code>æ¥æ¨¡æ‹Ÿï¼Œæµ‹è¯•è‡ªå·±å®¢æˆ·ç«¯å¤„ç†å“åº”çš„é€»è¾‘ã€‚</li><li>æœåŠ¡å™¨ç«¯åŸºæœ¬ä¸Šæ‰€æœ‰æ¡†æ¶éƒ½è‡ªå¸¦æœ‰ <code>test_client</code> ä½œä¸ºæœåŠ¡å™¨æµ‹è¯•å®¢æˆ·ç«¯ï¼ˆä¸åŒæ¡†æ¶åå­—å¯èƒ½ä¸ä¸€æ ·ï¼Œå…·ä½“å‚è€ƒæ–‡æ¡£ï¼‰</li></ol><p><a href="https://github.com/Dustyposa/goSpider/tree/master/python_advance/%E4%BD%BF%E7%94%A8python%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B" target="_blank" rel="noopener">å®Œæ•´ä»£ç åœ°å€</a></p></div><hr><div><p><span><i class="iconfont icon-inbox"></i> <a class="hover-with-bg" href="/categories/advance/">advance</a> &nbsp; </span>&nbsp;&nbsp; <span><i class="iconfont icon-tag"></i> <a class="hover-with-bg" href="/tags/python/">python</a> <a class="hover-with-bg" href="/tags/tests/">tests</a></span></p><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0åè®®</a> ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><div class="post-prev col-6"><a href="/2020/04/07/%E4%BD%BF%E7%94%A8python%E5%AE%A2ae%E4%BB%8Erequests%E8%AF%B7%E6%B1%82%E9%87%8D%E8%AF%95%E5%88%B0%E4%B8%87%E8%83%BD%E9%87%8D%E8%AF%95%E8%A3%85%E9%A5%B0%E5%99%A8/"><i class="fa fa-chevron-left"></i> <span class="hidden-mobile">ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></div><div class="post-next col-6"><a href="/2020/04/07/python_requests_%E4%BB%A3%E7%90%86%E5%92%8C%E9%87%8D%E5%AE%9A%E5%90%91%E4%BF%A1%E6%81%AF/"><span class="hidden-mobile">python requests ä»£ç†å’Œé‡å®šå‘ä¿¡æ¯</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="fa fa-chevron-right"></i></a></div></div></div><div class="comments" id="comments"><script defer src="https://utteranc.es/client.js" repo="Dustyposa/utterances_comments" issue-term="pathname" label="âœ¨ğŸ’¬âœ¨" theme="github-light" crossorigin="anonymous"></script></div></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc-start"></div><div id="toc"><p class="h5"><i class="far fa-list-alt"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a class="z-depth-1" id="scroll-top-button" href="#" role="button"><i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><b>Fluid</b></a></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js"></script><script>$(document).ready(function(){var s=$("#navbar").height(),c=$("#toc"),t=$("#board-ctn"),o=t.offset().top,i=2*o+t.height();$(window).scroll(function(){var t=$("#toc-start").offset().top-s,o=document.body.scrollTop+document.documentElement.scrollTop;t<=o&&o<=i?c.css({display:"block",position:"fixed",top:s}):o<=t?c.css({position:"",top:""}):i<o&&c.css("display","none")}),tocbot.init({tocSelector:"#tocbot",contentSelector:".post-content",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,headingsOffset:-o}),0<$(".toc-list-item").length&&$("#toc > p").css("visibility","visible");var l=t.css("margin-right");$("#toc-ctn").css({right:l})})</script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js"></script><script>$(document).ready(function(){$("pre").addClass("prettyprint  "),prettyPrint()})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","ä½¿ç”¨pythonå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åŠŸèƒ½æµ‹è¯•å®ä¾‹&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){getSearchFile(path),this.onclick=null}</script><script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><script>$("#post img:not(.no-zoom img, img[no-zoom])").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script></body></html>