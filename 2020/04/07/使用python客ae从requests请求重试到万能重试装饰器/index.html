<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" type="image/png" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content="ä¸€äº›ç»éªŒçš„è®°å½•ã€‚"><meta name="author" content="Dusty Posa"><meta name="keywords" content="python,python3,process,script"><title>ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨ - Posaã®ã«ã‚</title><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css"><link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"><link rel="stylesheet" href="/css/main.css"><link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Posaã®ã«ã‚</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/">é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/">å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/">åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/">æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/about/">å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2" id="background" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask rgba-black-light flex-center"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><p class="mt-3 post-meta"><i class="fas fa-calendar-alt" aria-hidden="true"></i> æ˜ŸæœŸäºŒ, å››æœˆ 7æ—¥ 2020, 10:02 ä¸Šåˆ</p><p class="mt-1"><span class="post-meta"><i class="far fa-chart-bar"></i> 5k å­— </span><span class="post-meta"><i class="far fa-clock"></i> 20 åˆ†é’Ÿ</span></p></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5 z-depth-3" id="board"><div class="post-content mx-auto" id="post"><p class="note note-warning">æœ¬æ–‡æœ€åæ›´æ–°äºï¼šæ˜ŸæœŸä¸€, å››æœˆ 13æ—¥ 2020, 6:02 æ—©ä¸Š</p><div class="markdown-body"><h2 id="ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨"><a href="#ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨" class="headerlink" title="ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨"></a>ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨</h2><p>é‡è¯•ï¼Œåœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ã€‚<br>æ¯”å¦‚ï¼š</p><ol><li>è¯·æ±‚é‡è¯•ï¼ˆä¾‹å¦‚ï¼šè¶…æ—¶ï¼‰</li><li>æ–‡ä»¶å ç”¨</li><li>IOé˜»å¡ç­‰å¾…</li></ol><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•ç¼–å†™é‡è¯•çš„ä»£ç å‘¢ï¼Ÿ<br>æœ¬æ–‡å°†ä»è¯·æ±‚é‡è¯•å¼€å§‹ï¼Œå¸¦å¤§å®¶ä»ç®€å•çš„è¶…æ—¶é‡è¯•ï¼Œæœ€åç¼–å†™åˆ°ä¸‡èƒ½é”™è¯¯é‡è¯•ã€‚</p><blockquote><p>ä¸»è¦æ¶‰åŠå†…å®¹ï¼š</p><ul><li>requests adapter</li><li>å‡½æ•°è£…é¥°å™¨</li><li>ç±»è£…é¥°å™¨</li></ul></blockquote><p>è¯ä¸å¤šè¯´ï¼Œstartï¼</p><p><strong>å› ä¸ºæˆ‘ä»¬éœ€è¦ä» <code>requests</code> è¯·æ±‚é‡è¯•å¼€å§‹ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•è¯·æ±‚ï¼Œæˆ‘ä»¬ç”¨ <code>flask</code> ç¼–å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ï¼Œç”¨äºè¯·æ±‚æµ‹è¯•ã€‚</strong></p><h2 id="å‡†å¤‡è¯·æ±‚æœåŠ¡å™¨"><a href="#å‡†å¤‡è¯·æ±‚æœåŠ¡å™¨" class="headerlink" title="å‡†å¤‡è¯·æ±‚æœåŠ¡å™¨"></a>å‡†å¤‡è¯·æ±‚æœåŠ¡å™¨</h2><p>æœåŠ¡å™¨çš„åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œç”¨æ¥æŸ¥çœ‹è¯·æ±‚æ¬¡æ•°å’Œè§‚å¯Ÿæ˜¯å¦é‡è¯•æˆåŠŸï¼Œ<code>flask_server.py</code>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">from time import sleep

from flask import Flask, jsonify, Response

app: Flask = Flask(__name__)

retry_count: int = 0  # ç”¨äºé‡è¯•è¯·æ±‚çš„è®¡æ•°


@app.route(&quot;/api/retry&quot;, methods=[&quot;GET&quot;])
def retry_api() -&gt; Response:
    &quot;&quot;&quot;
    å»¶æ—¶ 1s çš„è¯·æ±‚æ¥å£ï¼Œ å“åº”æ—¶é—´ &gt; 1sã€‚
    :return:
    &quot;&quot;&quot;
    global retry_count
    retry_count += 1
    print(f&quot;è¿™æ˜¯ç¬¬{retry_count}æ¬¡è¯·æ±‚&quot;)
    if retry_count &lt; 3:
        sleep(1)
    else:
        retry_count = 0  # è®¡æ•°æ¸…é›¶
    return jsonify({&quot;msg&quot;: &quot;å·²ç»ä¸‰æ¬¡äº†å“¦ï¼&quot;})


if __name__ == &#39;__main__&#39;:
    app.run()
</code></pre><p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œç”±äºæ²¡æœ‰æ‰¾åˆ°å¥½ç”¨çš„<code>flask</code>ä¸Šä¸‹æ–‡æ¥å®Œæˆè®¡æ•°éœ€æ±‚ï¼Œè¿™é‡Œä¸ºäº†ç®€å•æ“ä½œï¼Œå°±ç›´æ¥åº”ç”¨äº†å…¨å±€å˜é‡æ¥è®¡æ•°ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼ŒæœªåŠ é”ï¼‰ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨<code>redis</code>æ•°æ®åº“æ¥è®¡æ•°äº†ã€‚</p><p>ç¼–å†™å¥½ä¹‹åï¼Œæˆ‘ä»¬è¿è¡Œä»£ç å³å¯ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ç”¨æ¥æµ‹è¯•é‡è¯•çš„æœåŠ¡å™¨å°±å‡†å¤‡å¥½äº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸€èˆ¬çš„ <code>requests</code> è¶…æ—¶è¯·æ±‚å¦‚ä½•å®ç°ã€‚</p><h2 id="1-requests-è¯·æ±‚é‡è¯•ï¼ˆå¸¸è§ç‰ˆæœ¬ï¼‰"><a href="#1-requests-è¯·æ±‚é‡è¯•ï¼ˆå¸¸è§ç‰ˆæœ¬ï¼‰" class="headerlink" title="1.requests è¯·æ±‚é‡è¯•ï¼ˆå¸¸è§ç‰ˆæœ¬ï¼‰"></a>1.<code>requests</code> è¯·æ±‚é‡è¯•ï¼ˆå¸¸è§ç‰ˆæœ¬ï¼‰</h2><p>æˆ‘ä»¬ç”¨ <code>try...except...</code> è¯­å¥æ•æ‰<code>timeout</code>é”™è¯¯ã€‚è¿›è¡Œå¾ªç¯é‡è¯•å³å¯ã€‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå‡½æ•° <code>get_data</code>ï¼Œ<code>normal.py</code>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">from typing import Dict, Any

import requests

BaseDictData = Dict[str, Any]


def get_data(url: str, max_retry: int = 0, time_out: float = 3., **kwargs) -&gt; BaseDictData:
    &quot;&quot;&quot;è‡ªåŠ¨é‡è¯• timeout é”™è¯¯ çš„æ–¹æ³•&quot;&quot;&quot;
    params: BaseDictData = kwargs.get(&quot;params&quot;, {})  # ä¸ç®¡ä½ ä¼ äº†ä»€ä¹ˆå¥‡æ€ªçš„ä¸œè¥¿ï¼Œ æˆ‘åªæ”¶è¿™ä¸ª
    headers: BaseDictData = kwargs.get(&quot;headers&quot;, {})  # åŒä¸Š
    for i in range(max_retry + 1):
        &quot;&quot;&quot;è¿›è¡Œæœ€å¤§é‡è¯•æ¬¡æ•°çš„éå†&quot;&quot;&quot;
        try:
            response: requests.Response = requests.get(
                url=url,
                params=params,
                headers=headers,
                timeout=time_out,
            )
        except requests.ReadTimeout:
            print(f&quot;ç¬¬{i + 1}æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ã€‚&quot;)
        else:
            return response.json()  # æ²¡æœ‰é”™è¯¯ï¼Œç›´æ¥è¿”å›

    print(f&quot;{max_retry + 1} æ¬¡è¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œè¿”å›ç©ºå€¼ï¼Œä¾¿äºåç»­é€»è¾‘å¤„ç†ã€‚ã€‚ã€‚&quot;)
    return {}


if __name__ == &#39;__main__&#39;:
    print(get_data(&quot;http://localhost:5000/api/retry&quot;, max_retry=1, time_out=.01))
</code></pre><p>åœ¨è¯¥å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ <code>requests</code> åº“æœ¬èº«çš„ <code>timeout</code> å‚æ•°è¿›è¡Œé”™è¯¯æ•æ‰ã€‚æ•´ä½“æ¯”è¾ƒç®€å•ï¼Œè®¾è®¡é€»è¾‘å³ï¼š</p><pre class="mermaid">graph LR
A[è¯·æ±‚] -- è¶…æ—¶é‡è¯•--> A
A --æˆåŠŸ--> B[å¤„ç†æˆåŠŸåçš„æ•°æ®]
A--è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°-->C[è¿”å›ç©ºæ•°æ®ä¾¿äºåç»­é€»è¾‘å¤„ç†]</pre><p>å¦‚æœè¶…æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šå¼•å‘é”™è¯¯ï¼Œç„¶åç»§ç»­è¯·æ±‚ï¼Œç”¨<code>for</code>å¾ªç¯æ¥å¤„ç†å¾ªç¯é‡è¯•ï¼Œæ›´åŠ ç®€æ´ã€‚</p><p>è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œå°±è¿”å›ç©ºæ•°æ®ï¼ŒæˆåŠŸï¼Œè¿”å›æˆåŠŸæ•°æ®ã€‚</p><p>ä»£ç æ®µæ³¨æ„è¦ç‚¹ï¼š<br><strong><code>try...except...</code></strong> è¯­å¥</p><pre><code class="python">try:
    ...  # éœ€è¦æ•æ‰å¼‚å¸¸çš„ä»£ç 
except xxx:
    ...  # å‘ç”Ÿå¼‚å¸¸å¤„ç†é€»è¾‘
else:
    ...  # å¦‚æœ try æˆåŠŸæ‰§è¡Œï¼Œå°±æ‰§è¡Œelseï¼Œå¦åˆ™è·³è¿‡else
finally:
    ...  # ä¸€å®šä¼šæ‰§è¡Œè¯¥è¯­å¥å—</code></pre><p>æˆ‘ä»¬åœ¨ <code>try</code> è¯­å¥å—ä¸­åªè¿è¡Œäº†ä¸€è¡Œä»£ç ï¼Œå› ä¸ºè¿™æ¬¡æ•æ‰åªé’ˆå¯¹è¿™è¡Œä»£ç å¯èƒ½ä¼šå¼•èµ·çš„é”™è¯¯ï¼Œåšåˆ°<strong>ç²¾ç¡®æ•æ‰å¼‚å¸¸</strong>ã€‚</p><p>å¦‚æœ <code>try</code> è¯­å¥å—ä¸­çš„ä»£ç å¤ªå¤šçš„è¯ï¼ˆæ¯”å¦‚è¦åšå¤šä»¶äº‹æƒ…ï¼‰ï¼Œé”™è¯¯è°ƒè¯•å’Œé”™è¯¯å¤„ç†éƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“æ˜¯å“ªè¡Œå¼•èµ·çš„é”™è¯¯ï¼Œéœ€è¦åŠ ï¼ˆ<code>print</code>ï¼‰ æˆ–è€… ï¼ˆ<code>debug</code>ï¼‰æ¥æŸ¥çœ‹å…·ä½“é”™è¯¯åŸå› ï¼Œå¹¶ä¸”ä¸è¦æ‹…å¿ƒä½¿ç”¨<code>try...except...</code>è¯­å¥ï¼Œ<code>python</code>ä¸­çš„å¼‚å¸¸å¤„ç†ä»£ä»·æ˜¯å¾ˆå°çš„ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿæ˜¯å¾ˆå¸¸è§çš„ã€‚</p><p>è€Œ<code>else</code>è¯­å¥å—ï¼Œå°±æ˜¯æ­£å¸¸é€»è¾‘çš„è¡¥å……å¤„ç†ã€‚</p><p><strong>TIPS:</strong><br><strong>åœ¨ <code>for...in...:</code>è¯­å¥ä¸­ä¹Ÿæœ‰<code>else</code>è¯­å¥å—ï¼Œå¯¹å®Œæˆå¾ªç¯åè¿›è¡Œè¡¥å……ã€‚</strong></p><details><summary><code>for...in...</code>ç¤ºä¾‹</summary><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬è¦å¾ªç¯æ£€æµ‹ä¸€ä¸ªåˆ—è¡¨<code>check_data: List[Union[int, str]] = [1, 2, 3, 4]</code>æ˜¯å¦æœ‰å­—ç¬¦ä¸²ï¼Œå¦‚æœæœ‰å­—ç¬¦ä¸²æˆ‘ä»¬å°±ä¸è¿›è¡Œåç»­å¤„ç†ï¼Œå¦‚è¿‡æ²¡æœ‰å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å°±è°ƒç”¨ <code>handle_data</code> å‡½æ•°ã€‚</p><p>ä¸ºäº†æ»¡è¶³ä¸Šé¢çš„éœ€æ±‚ï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬éƒ½ä¼šå†™ä¸€ä¸ª <code>tag/signal</code>æ¥æ ‡æ³¨çŠ¶æ€ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="python">has_string: bool = False
for data in check_data:
    if isinstance(data, str):
        has_string = True
        break

if not has_string:
    # æ²¡æœ‰å­—ç¬¦ä¸²çš„æƒ…å†µä¸‹
    handle_data() </code></pre><p>æœ‰äº† <code>else</code> æˆ‘ä»¬å°±å¯ä»¥ç®€åŒ–ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p><pre><code class="python">for data in check_data:
    if isinstance(data, str):
        break
else:
    # æ²¡æœ‰å­—ç¬¦ä¸²çš„æƒ…å†µä¸‹
    handle_data() </code></pre><p>è¿™æ ·é€»è¾‘å°±å¯ä»¥æ›´æ¸…æ™°ä¸€äº›ã€‚å¦å¤–ï¼Œ <code>while å¾ªç¯</code>ä¹Ÿæ”¯æŒ <code>else</code> è¯­å¥ï¼Œè¿™é‡Œå°±ä¸é‡å¤æ¼”ç¤ºäº†ã€‚</p></details><h4 id="æŸ¥çœ‹æ•ˆæœã€‚"><a href="#æŸ¥çœ‹æ•ˆæœã€‚" class="headerlink" title="æŸ¥çœ‹æ•ˆæœã€‚"></a>æŸ¥çœ‹æ•ˆæœã€‚</h4><p>æˆ‘ä»¬è°ƒç”¨ <code>print(get_data(&quot;http://localhost:5000/api/retry&quot;, max_retry=2, time_out=.01))</code><br>å®¢æˆ·ç«¯ç»“æœ:</p><pre><code>ç¬¬1æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ã€‚
ç¬¬2æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ã€‚
{&#39;msg&#39;: &#39;å·²ç»ä¸‰æ¬¡äº†å“¦ï¼&#39;}</code></pre><p>æœåŠ¡ç«¯ç»“æœï¼š</p><pre><code>è¿™æ˜¯ç¬¬1æ¬¡è¯·æ±‚
è¿™æ˜¯ç¬¬2æ¬¡è¯·æ±‚
è¿™æ˜¯ç¬¬3æ¬¡è¯·æ±‚</code></pre><p>è¿™é‡Œ <code>max_retry</code> ä¸ºæœ€å¤§<strong>é‡è¯•</strong>æ¬¡æ•°ï¼Œæ‰€ä»¥æœ€å¤§è¯·æ±‚æ¬¡æ•°ä¸º<code>1+max_retry</code>ã€‚</p><p>æˆ‘ä»¬è°ƒç”¨<code>print(get_data(&quot;http://localhost:5000/api/retry&quot;, max_retry=1, time_out=.01))</code><br>å®¢æˆ·ç«¯ç»“æœ:</p><pre><code>ç¬¬1æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ã€‚
ç¬¬2æ¬¡è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ã€‚
2 æ¬¡è¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œè¿”å›ç©ºå€¼ï¼Œä¾¿äºåç»­é€»è¾‘å¤„ç†ã€‚ã€‚ã€‚
{}</code></pre><p>æœåŠ¡ç«¯ç»“æœï¼š</p><pre><code>è¿™æ˜¯ç¬¬1æ¬¡è¯·æ±‚
è¿™æ˜¯ç¬¬2æ¬¡è¯·æ±‚</code></pre><p>å¯ä»¥çœ‹å‡ºï¼Œæ•´ä½“æ•ˆæœä¹Ÿæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œæ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚<br>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨<code>requests</code>è‡ªå¸¦çš„è¯·æ±‚é‡è¯•å™¨ã€‚</p><h2 id="2-requests-adapter-é‡è¯•"><a href="#2-requests-adapter-é‡è¯•" class="headerlink" title="2. requests adapter é‡è¯•"></a>2. <code>requests adapter</code> é‡è¯•</h2><p><code>requests</code> æœ‰ä¸€ä¸ª <code>HTTPAdapter</code> å¯¹è±¡ï¼Œçœ‹åå­—å°±æœ‰ä¸€ç§å¯ä»¥ç»™ <code>requests</code>åŠ ç‰¹æ•ˆçš„æ„Ÿè§‰ã€‚</p><p>ä¸è¿‡ <code>HTTPAdapter</code> ä¸»è¦å¯ä»¥å®ç°ï¼š</p><blockquote><p>åˆ›å»ºè¿æ¥æ± ï¼Œï¼ˆç±»ä¼¼çº¿ç¨‹æ± ï¼Œè¿›ç¨‹æ± ï¼Œè¿æ¥å¯æœç”¨ï¼‰<br>é™å®šè¿æ¥æ± æ•°é‡ï¼ˆé¿å…è¿æ¥æ•°è¿‡å¤šï¼ˆçº¿ç¨‹è¿‡å¤šï¼‰ï¼‰ã€‚<br>é‡è¯•è¯·æ±‚ã€‚</p></blockquote><p><code>requests_built.py</code>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">import requests
from requests.adapters import HTTPAdapter

from normal import BaseDictData


def get_data(url: str, max_retry: int = 0, time_out: float = 1., **kwargs) -&gt; BaseDictData:
    &quot;&quot;&quot;
    è‡ªåŠ¨é‡è¯• timeout é”™è¯¯ çš„æ–¹æ³•, ç”¨ requests è‡ªå¸¦è½®å­å®Œæˆï¼
    :param url: è¯·æ±‚çš„ url
    :param max_retry: æœ€å¤§é‡è¯•æ¬¡æ•°
    :param time_out: è¶…æ—¶é‡è¯•æ—¶é—´
    :param kwargs: å¯é€‰å‘½åå‚æ•°
    :return: BaseDictData
    &quot;&quot;&quot;
    session: requests.Session = kwargs.get(&quot;session&quot;, requests.Session())  # è·å–session æˆ–è€…æ–°å»º session
    params: BaseDictData = kwargs.get(&quot;params&quot;, {})  # ä¸ç®¡ä½ ä¼ äº†ä»€ä¹ˆå¥‡æ€ªçš„ä¸œè¥¿ï¼Œ æˆ‘åªæ”¶è¿™ä¸ª
    headers: BaseDictData = kwargs.get(&quot;headers&quot;, {})  # åŒä¸Š
    adapter: HTTPAdapter = HTTPAdapter(max_retries=max_retry)  # åˆå§‹è‡ªå¸¦å¤„ç†é¢å¤–æ“ä½œçš„é€‚é…å™¨
    session.mount(&quot;http://127.0.0.1&quot;, adapter=adapter)  # ç»™æˆ‘ä»¬çš„ session å®‰è£…ä¸Š adapter, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸»æœºï¼Œä»£è¡¨å¯¹äºå“ªå°ä¸»æœºçš„è¯·æ±‚éœ€è¦è£…ä¸Šé€‚é…å™¨
    try:
        response: requests.Response = session.get(
            url,
            params=params,
            headers=headers,
            timeout=time_out
        )
    except requests.ConnectTimeout:
        print(f&quot;{max_retry + 1}æ¬¡è¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œå³å°†è¿”å›ç©ºå€¼ï¼Œè¯·è€å¿ƒç­‰å¾…...&quot;)
    else:
        session.close()  # å…³é—­ session, æºç ä¸»è¦æ˜¯æ¸…é™¤æ‰€æœ‰è£…é…å™¨
        return response.json()
    return {}


if __name__ == &#39;__main__&#39;:
    res = get_data(&quot;http://127.0.0.1:5000/api/retry&quot;, 3)
    print(res)</code></pre><p>æ•´ä½“ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨å¸¸è§„è¯·æ±‚ä¹‹ä¸Šï¼Œä¸»è¦åŠ äº†ä¸¤è¡Œä»£ç ã€‚å°±æ˜¯ç»™ <code>Session</code> å¯¹è±¡ç”¨ <code>mount</code> æ–¹æ³•ç»™å¯¹äº <code>http://127.0.0.1</code>çš„ä¸»æœºè¯·æ±‚åŠ ä¸Šäº† <code>adapter</code>ï¼Œè¯¥<code>adapter</code>å¯¹è±¡å¢åŠ äº†æœ€å¤§çš„é‡è¯•æ¬¡æ•°ã€‚</p><p>PSï¼š</p><ul><li>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ <code>http://</code> æ¥è¡¨ç¤ºå¯¹äºæ‰€æœ‰<code>httpè¯·æ±‚</code>çš„ä¸»æœºéƒ½è£…ä¸Š<code>adapter</code></li><li>æˆ‘ä»¬ä¹Ÿå¯ä»¥é’ˆå¯¹å¤šä¸ªè¯·æ±‚ä¸»æœº<pre><code class="python">session.mount(&quot;http://127.0.0.1&quot;, adapter=adapter)
session.mount(&quot;https://github.com&quot;, adapter=adapter)</code></pre>è¿è¡Œç»“æœï¼ˆæœåŠ¡å™¨ç«¯ç›¸ä¼¼ï¼Œä¹‹åçš„å±•ç¤ºåªå±•ç¤ºå®¢æˆ·ç«¯ï¼‰:</li></ul><p><code>print(get_data(&quot;http://127.0.0.1:5000/api/retry&quot;, 2))</code></p><p>å®¢æˆ·ç«¯ï¼š</p><pre><code>{&#39;msg&#39;: &#39;å·²ç»ä¸‰æ¬¡äº†å“¦ï¼&#39;}</code></pre><p><code>print(get_data(&quot;http://127.0.0.1:5000/api/retry&quot;, 1))</code></p><p>å®¢æˆ·ç«¯ï¼š</p><pre><code>2æ¬¡è¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œå³å°†è¿”å›ç©ºå€¼ï¼Œè¯·è€å¿ƒç­‰å¾…...
{}</code></pre><h2 id="3-æ„é€ è¯·æ±‚é‡è¯•è£…é¥°å™¨"><a href="#3-æ„é€ è¯·æ±‚é‡è¯•è£…é¥°å™¨" class="headerlink" title="3.æ„é€ è¯·æ±‚é‡è¯•è£…é¥°å™¨"></a>3.æ„é€ è¯·æ±‚é‡è¯•è£…é¥°å™¨</h2><p>é€šè¿‡å‰ä¸¤ä¸ªæ–¹æ³•æ¥çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“ä¸»è¦çš„é‡è¯•æ–¹å¼æœ‰ä¸¤ç§ï¼š</p><ol><li>å¾ªç¯è¯·æ±‚</li><li><code>requests</code>è‡ªå¸¦çš„é€‚é…å™¨</li></ol><p>ä½†æ˜¯å‘¢ï¼Œè¿™ä¸¤ç§ï¼Œå¯å¤ç”¨æ€§ä¸å¤ªå¼ºï¼Œæˆ‘ä»¬å‡çº§ä¸€ä¸‹ï¼Œç”¨è£…é¥°å™¨æ¥è¯•è¯•ã€‚ï¼ˆå½“ç„¶ï¼Œä¹Ÿæœ‰å…¶ä»–å¤ç”¨æ–¹æ³•ï¼Œæ¯”å¦‚åˆ›å»ºé‡è¯•ä¸“ç”¨å¯¹è±¡ï¼Œæˆ–è€…åŠ å…¥é‡è¯•è°ƒåº¦å™¨ï¼‰</p><p>å½“ç„¶è£…é¥°å™¨çš„å†™æ³•ï¼Œæˆ‘ä»¬è‡³å°‘ä¹Ÿå¯ä»¥å†™å‡ºä¸¤ç§ç‰ˆæœ¬ã€‚</p><details><summary>pythonè£…é¥°å™¨åŸç†é€Ÿè§ˆ</summary><p>ç»Ÿè®¡å‡½æ•°è¿è¡Œæ—¶é—´çš„è£…é¥°å™¨<code>derector.py</code>ï¼š</p><pre><code class="python">import time


def count_fun_time(func):
    def wrapper(*arg, **kwargs):
        start_time = time.time()
        res = func(*arg, **kwargs)
        print(f&quot;å‡½æ•°æ€»å…±è¿è¡Œäº†{time.time() - start_time:.2f}s&quot;)
        return res
    return wrapper


def my_function(time_wait: int = 3):
    time.sleep(time_wait)
    print(&quot;è¿è¡Œç»“æŸ&quot;)


my_function = count_fun_time(my_function)
my_function()
my_function(4)</code></pre><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸ºåŸå§‹ç‰ˆæœ¬ï¼Œå°±æ˜¯åˆ©ç”¨å‡½æ•°çš„<strong>é—­åŒ…ç‰¹æ€§(é—­åŒ…å‡½æ•°)</strong>ï¼Œåœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨å‡½æ•°ï¼ŒåŒæ—¶è¿›è¡Œå…¶ä»–æ“ä½œå³å¯ã€‚</p><p>ç„¶åå°†<strong>æ–°å‡½æ•°é‡æ–°å‘½åä¸ºåŸå‡½æ•°çš„åå­—</strong>ã€‚</p><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code> è¿è¡Œç»“æŸ
å‡½æ•°æ€»å…±è¿è¡Œäº†3.00s
è¿è¡Œç»“æŸ
å‡½æ•°æ€»å…±è¿è¡Œäº†4.00s</code></pre><p>å½“ç„¶ï¼Œç®€ä¾¿çš„pythonä¸ä¼šè®©ä½ è¿™æ ·å†™ï¼Œäºæ˜¯ï¼Œè¯­æ³•ç³–ä¾¿å‡ºç°äº†ã€‚</p><p>æˆ‘ä»¬çš„è®¡ç®—è¿è¡Œæ—¶é—´çš„è£…é¥°å™¨å‡½æ•° <code>count_fun_time</code>ä¸å˜ï¼Œ</p><p>åªéœ€è¦åœ¨<code>my_funtion</code>ä¸Šé¢åŠ ä¸Šç³–<code>@count_fun_time</code> å³å¯ã€‚</p><pre><code class="python">@count_fun_time
def my_function(time_wait: int = 3):
    time.sleep(time_wait)
    print(&quot;è¿è¡Œç»“æŸ&quot;)

my_function()
my_function(4)</code></pre><p>ä»ä¸Šé¢çš„ä»£ç æˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼Œè£…é¥°å™¨å‡½æ•°ä½¿ç”¨è¯­æ³•ç³–ä¹‹åæ›´åŠ çš„<strong>ä¼˜é›…å’Œæ˜“æ‡‚ã€‚</strong></p><p>ä½†æ˜¯åœ¨è£…é¥°å™¨è£…é¥°å…ƒå‡½æ•°ä¹‹åï¼Œå…ƒä¿¡æ¯æœ‰æ‰€æŸå(ä¾‹å¦‚:<code>my_function.__name__</code>ç¼ºå¤±)ï¼Œéœ€è¦è¿›è¡Œæ”¹è‰¯ï¼ˆæ”¹è‰¯æ–¹æ³•åœ¨ä¸‹æ–‡ä¸­å‡ºç°ã€‚ï¼‰</p></details><h3 id="3-1-æ„é€ è¢«è£…é¥°çš„å‡½æ•°get-data"><a href="#3-1-æ„é€ è¢«è£…é¥°çš„å‡½æ•°get-data" class="headerlink" title="3.1 æ„é€ è¢«è£…é¥°çš„å‡½æ•°get_data"></a>3.1 æ„é€ è¢«è£…é¥°çš„å‡½æ•°<code>get_data</code></h3><p>æ—¢ç„¶æ˜¯è£…é¥°å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª<strong>è¯·æ±‚å‡½æ•°</strong>ï¼Œå½“ä½œè¢«è£…é¥°çš„å‡½æ•°ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">def get_data(url: str, time_out: float = 3., **kwargs) -&gt; BaseDictData:
    &quot;&quot;&quot;
    è‡ªåŠ¨é‡è¯• timeout é”™è¯¯ çš„æ–¹æ³•, ç”¨ requests è‡ªå¸¦è½®å­å®Œæˆï¼
    :param url: è¯·æ±‚çš„ url
    :param time_out: è¶…æ—¶é‡è¯•æ—¶é—´
    :param kwargs: å¯é€‰å‘½åå‚æ•°
    :return: BaseDictData
    &quot;&quot;&quot;
    session: requests.Session = kwargs.get(&quot;session&quot;, requests.Session())  # è·å–session æˆ–è€…æ–°å»º session
    params: BaseDictData = kwargs.get(&quot;params&quot;, {})  # ä¸ç®¡ä½ ä¼ äº†ä»€ä¹ˆå¥‡æ€ªçš„ä¸œè¥¿ï¼Œ æˆ‘åªæ”¶è¿™ä¸ª
    headers: BaseDictData = kwargs.get(&quot;headers&quot;, {})  # åŒä¸Š
    with session.get(url, params=params, headers=headers, timeout=time_out) as response:
        return response.json()</code></pre><p>ä»£ç å¾ˆç®€å•ï¼Œä¸ºäº†é€šç”¨æ€§ï¼ˆå› ä¸ºæœ‰ä¸¤ç§è£…é¥°å™¨ï¼Œå¾ªç¯å’Œ<code>adapter</code>)ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>Sessionå¯¹è±¡</code>æ¥åšè¯·æ±‚ã€‚</p><p>å¥½äº†ï¼Œå¼€å§‹è£…é¥°å™¨çš„æ­£é¢˜ã€‚</p><h3 id="3-1-å¾ªç¯é‡è¯•è£…é¥°å™¨"><a href="#3-1-å¾ªç¯é‡è¯•è£…é¥°å™¨" class="headerlink" title="3.1  å¾ªç¯é‡è¯•è£…é¥°å™¨"></a>3.1 å¾ªç¯é‡è¯•è£…é¥°å™¨</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ„æ€ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„è£…é¥°å™¨è¦å®Œæˆä»€ä¹ˆã€‚</p><p><code>get_data</code> è¿™ä¸ªå‡½æ•°ä¸ºå†…éƒ¨å‡½æ•°ï¼Œå¯èƒ½<code>timeout</code>ï¼Œæˆ‘ä»¬å¤ç”¨ä¹‹å‰å†™çš„é”™è¯¯å³å¯ï¼Œç„¶åæ•æ‰è¯¥é”™è¯¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå¦‚æœè¿è¡Œå‡½æ•°å‡ºé”™ï¼Œæˆ‘ä»¬å°±è¿›è¡Œå¾ªç¯é‡è¯•ã€‚</p><h4 id="3-1-1-åŸºæœ¬å¾ªç¯é‡è¯•è£…é¥°å™¨"><a href="#3-1-1-åŸºæœ¬å¾ªç¯é‡è¯•è£…é¥°å™¨" class="headerlink" title="3.1.1 åŸºæœ¬å¾ªç¯é‡è¯•è£…é¥°å™¨"></a>3.1.1 åŸºæœ¬å¾ªç¯é‡è¯•è£…é¥°å™¨</h4><p>æ•´ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">from functools import wraps

def retry(func):
    @wraps(func)  # ä¿ç•™è¢«è£…é¥°å‡½æ•°çš„å…ƒä¿¡æ¯
    def closure(*args, **kwargs) -&gt; BaseDictData:
        for i in range(3):
            try:
                res = func(*args, **kwargs)
            except (requests.ConnectTimeout, requests.ReadTimeout):
                print(f&quot;ç¬¬{i + 1}æ¬¡é‡è¯•ã€‚&quot;)
            else:
                return res
        return {}
    return closure

@retry
def get_data(...):
    --skip--</code></pre><p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ <code>@wraps</code> ä¿ç•™å…ƒå‡½æ•°ä¿¡æ¯ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å®Œæ•´çš„è¢«è£…é¥°åå‡½æ•°çš„ä¿¡æ¯ã€‚ä¾‹å¦‚:<code>get_data.__name__ï¼Œ å‡½æ•°ç­¾åï¼Œå‡½æ•°æ–‡æ¡£ç­‰</code>ã€‚</p><p>è¿è¡Œç»“æœç±»ä¼¼ï¼Œæˆ‘ä»¬å°±ä¸å±•ç¤ºäº†ï¼Œå†…å®¹æœ‰ç‚¹é‡å¤ã€‚<br>æ•´ä½“é€»è¾‘å…¶å®å’Œ<code>for...in...</code>å¾ªç¯çš„é‡è¯•åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯æˆ‘ä»¬å°è£…æˆäº†ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ°å¤„ç”¨ï¼ç®€ç›´ä¸èƒ½å¤ªæ–¹ä¾¿ã€‚<br>äºæ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>except (requests.ConnectTimeout, requests.ReadTimeout)</code> è¿™ä¸ªåœ°æ–¹ï¼å¯ä»¥æ“ä½œä¸€ä¸‹ï¼Œå‡å¦‚é”™è¯¯ç±»å‹æ˜¯å˜é‡ï¼Œé‚£æ˜¯ä¸æ˜¯å°±å¯ä»¥æ•æ‰æƒ³æ•æ‰çš„ä»»æ„é”™è¯¯äº†ã€‚ å¹¶ä¸”ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°æˆ‘ä»¬æ˜¯å†™æ­»çš„ï¼Œè¿™é‡Œè‚¯å®šä¹Ÿèƒ½å†™æˆå˜é‡ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•ä¹¦å†™å‘¢ï¼Ÿ</p><p><strong>å†åŠ ä¸€å±‚é—­åŒ…ã€‚</strong> æ²¡é”™ï¼Œæˆ‘ä»¬å†å¥—ä¸€å±‚å‡½æ•°å³å¯ã€‚</p><h4 id="3-1-2-ä»»æ„é”™è¯¯å¾ªç¯é‡è¯•çš„å‡½æ•°è£…é¥°å™¨"><a href="#3-1-2-ä»»æ„é”™è¯¯å¾ªç¯é‡è¯•çš„å‡½æ•°è£…é¥°å™¨" class="headerlink" title="3.1.2 ä»»æ„é”™è¯¯å¾ªç¯é‡è¯•çš„å‡½æ•°è£…é¥°å™¨"></a>3.1.2 ä»»æ„é”™è¯¯å¾ªç¯é‡è¯•çš„å‡½æ•°è£…é¥°å™¨</h4><p><code>strong_retry</code>ä»£ç å¦‚ä¸‹:</p><pre><code class="python">def strong_retry(
        max_retry: int = 3,
        exception: Tuple[BaseException] = (
                requests.ConnectTimeout,
                requests.ReadTimeout,
        )
):
    &quot;&quot;&quot;
    ä¸‡èƒ½å‡½æ•°é‡è¯•è£…é¥°å™¨è¯ç”Ÿï¼
    :param max_retry: æœ€å¤§é‡è¯•æ¬¡æ•°
    :param exception: æ•æ‰é”™è¯¯ç±»å‹
    :return:
    &quot;&quot;&quot;

    def retry(func):
        @wraps(func)  # ä¿ç•™è¢«è£…é¥°å‡½æ•°çš„å…ƒä¿¡æ¯
        def closure(*args, **kwargs) -&gt; BaseDictData:
            for i in range(max_retry + 1):
                try:
                    res = func(*args, **kwargs)
                except exception:
                    print(f&quot;ç¬¬{i + 1}æ¬¡é‡è¯•ã€‚&quot;)
                else:
                    return res
            return {}
        return closure
    return retry

@strong_common_retry(max_retry=4, exception=(requests.ReadTimeout,))
def get_data(...):
    # è£…é¥°å‡½æ•°ï¼Œæœ€å¤§é‡è¯•æ•°ä¸º 4ï¼Œ</code></pre><p>å†åœ¨å¤–å±‚å‡½æ•°å¸®åŠ©æˆ‘ä»¬ä¼ å…¥å‚æ•°ï¼Œå¹¶åœ¨åŸè£…é¥°å™¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å‚æ•°å³å¯ã€‚</p><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½é’ˆå¯¹<strong>æŸäº›é”™è¯¯è¿›è¡Œé‡è¯•</strong>æ“ä½œäº†ï¼ï¼ˆæœ‰ä¸€ä¸ªæ¨¡å— <code>retrying</code>, ä¹Ÿèƒ½è¿›è¡Œé”™è¯¯é‡è¯•ï¼Œæˆ‘ä»¬è½»æ¾çš„å®ç°äº†ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬ï¼ï¼‰</p><blockquote><p>ä¾‹å¦‚:<br>@strong_common_retry(exception=(ValueError, NameError)) # é’ˆå¯¹è¿™ä¸¤ä¸ªé”™è¯¯è¿›è¡Œæ•æ‰<br>ä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œåƒä¸‡ä¸è¦ç”¨ <code>exception=(BaseException,)</code> !!!!è¿™æ ·è¿<kbd>Ctrl/Command</kbd> + <kbd>C</kbd> éƒ½å¤±æ•ˆäº†ï¼ï¼ˆå¼•å‘<code>KeyboardInterrupt</code>é”™è¯¯çš„æ–¹æ³•ï¼‰</p></blockquote><p>åˆ°è¿™é‡Œå®Œäº†å—ï¼Ÿå½“ç„¶æ²¡æœ‰ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜èƒ½å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œå½“è£…é¥°å™¨å¸¦æœ‰å‚æ•°æ—¶ï¼Œè£…é¥°å™¨å‡½æ•°åµŒå¥—å±‚æ•°å¤ªå¤šã€‚å½±å“é˜…è¯»ï¼Œè¿™æ—¶å€™ï¼Œç¥­å‡ºæˆ‘ä»¬çš„è£…é¥°å™¨ç¥å™¨<code>wrapt</code>ã€‚(éœ€è¦ <code>pip install wrapt</code>)<br>ä½¿ç”¨åä»£ç å¦‚ä¸‹:</p><pre><code class="python">def strong_common_retry(max_retry, exception):
    @wrapt.decorator  # ä¿ç•™è¢«è£…é¥°å‡½æ•°çš„å…ƒä¿¡æ¯
    def wrapper(wrapped, instance, args, kwargs) -&gt; BaseDictData:
        &quot;&quot;&quot;

        :param wrapped: 
        :param instance:å¦‚æœè¢«è£…é¥°è€…ä¸ºæ™®é€šç±»æ–¹æ³•ï¼Œè¯¥å€¼ä¸ºç±»å®ä¾‹
                        å¦‚æœè¢«è£…é¥°è€…ä¸º classmethod ç±»æ–¹æ³•ï¼Œè¯¥å€¼ä¸ºç±»
                        å¦‚æœè¢«è£…é¥°è€…ä¸ºç±»/å‡½æ•°/é™æ€æ–¹æ³•ï¼Œè¯¥å€¼ä¸º None 
        :param args: 
        :param kwargs: 
        :return: 
        &quot;&quot;&quot;
        for i in range(max_retry + 1):
            try:
                res = wrapped(*args, **kwargs)
            except exception:
                print(f&quot;ç¬¬{i + 1}æ¬¡é‡è¯•ã€‚&quot;)
            else:
                return res
        return {}
    return wrapper</code></pre><p>è¿™æ ·å¿«é€Ÿåœ°å°±<strong>å‡å°‘äº†è£…é¥°å™¨å‡½æ•°çš„åµŒå¥—å±‚æ•°</strong>ï¼ŒåŒæ—¶è¿˜èƒ½è§£å†³å¯¹ç±»ä¸­çš„å‡½æ•°è£…é¥°å™¨ç»‘å®šå¯¹è±¡çš„é—®é¢˜ã€‚</p><p>æ‰€ä»¥å½“éœ€è¦ç¼–å†™è£…é¥°å™¨å‡½æ•°çš„æ—¶å€™ï¼Œä¸å¦¨è¯•è¯•<code>wrapt</code>å§ï¼ç»å¯¹æ˜¯ä½ çš„å¥½å¸®æ‰‹ï¼</p><p>å¾ªç¯é‡è¯•æå®šäº†ï¼Œå‡½æ•°è£…é¥°å™¨ä¹Ÿè®²çš„å·®ä¸å¤šäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æœ‰é€‚é…å™¨è£…é¥°å™¨æ²¡æœ‰è®²ï¼Œæ€ä¹ˆåŠï¼å½“ç„¶æ¢ç‚¹èŠ±æ ·ï¼Œç±»çš„è£…é¥°å™¨ <strong>start</strong>ã€‚</p><h3 id="3-2-Sessioné€‚é…å™¨é‡è¯•"><a href="#3-2-Sessioné€‚é…å™¨é‡è¯•" class="headerlink" title="3.2 Sessioné€‚é…å™¨é‡è¯•"></a>3.2 <code>Session</code>é€‚é…å™¨é‡è¯•</h3><p>è¿™æ¬¡ï¼Œæˆ‘ä»¬çš„è£…é¥°å™¨éœ€è¦å®ç°å¯¹åŸè¯·æ±‚å‡½æ•°ä¸­çš„ <code>Sessionå¯¹è±¡</code> æ·»åŠ é€‚é…å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ç”¨ç±»æ¥å®ç°ã€‚</p><p>ä½†æ˜¯ç±»æ€ä¹ˆå®ç°å‘¢ï¼Ÿè£…é¥°å™¨å‡½æ•°æ¯”è¾ƒå¥½ç†è§£ï¼Œè°ƒç”¨å‡½æ•°<code>func()</code>ï¼Œæˆ‘ä»¬å°±èƒ½å®ŒæˆåŸå‡½æ•°çš„æ›¿ä»£ã€‚ä½†æ˜¯ç±»æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿ è¿™æ—¶å€™ï¼Œå°±éœ€è¦ python ç»™æˆ‘ä»¬æä¾›çš„é­”æœ¯æ–¹æ³•ï¼ˆåŒä¸‹æ–¹æ³•ï¼‰<code>__call__</code> æ¥å®ç°äº†ï¼</p><h4 id="3-2-1-ç±»è£…é¥°å™¨åŸç†"><a href="#3-2-1-ç±»è£…é¥°å™¨åŸç†" class="headerlink" title="3.2.1 ç±»è£…é¥°å™¨åŸç†"></a>3.2.1 ç±»è£…é¥°å™¨åŸç†</h4><p>å…¶å®<code>__call__</code>æ–¹æ³•ç†è§£æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯ä»¥è®©å®ä¾‹è¯çš„å¯¹è±¡ç›´æ¥è°ƒç”¨ã€‚Examples are as follows:</p><pre><code class="python">class MySpider:
    def __call__(self):
        print(f&quot;{self.__class__.__name__} is calling&quot;)


MySpider()()</code></pre><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br><code>MySpider is calling</code></p><p>è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸè°ƒç”¨äº†å®ä¾‹åŒ–å¯¹è±¡ã€‚</p><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªç„¶åœ°å†™å‡ºè£…é¥°å™¨ç±»ã€‚</p><pre><code class="python">class MySpider:
    def __init__(self, func: Callable):
        self.func = func

    def __call__(self, *args, **kwargs):
        print(&quot;reset for on second&quot;)
        time.sleep(1)
        res_data = self.func(*args, **kwargs)
        return res_data

    def at_once_run(self, *args, **kwargs):
        print(&quot;now, run the function&quot;)
        return self.func(*args, **kwargs)

def spider():
    print(&quot;æ­£åœ¨æŠ“å–&quot;)

spider = MySpider(spider)
spider()</code></pre><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre><code>reset for on second
æ­£åœ¨æŠ“å–</code></pre><p>ä¸è£…é¥°å™¨å‡½æ•°å¾ˆåƒï¼Œæ ¸å¿ƒå°±æ˜¯ <code>__call__</code> æ–¹æ³•ã€‚<br>é‚£ä¹ˆç±»çš„è£…é¥°å™¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ</p><blockquote><ol><li>æ²¡æœ‰å¤æ‚çš„å‡½æ•°åµŒå¥—ï¼Œé˜…è¯»ä»£ç æ—¶æ›´åŠ æ¸…æ™°ï¼Œæ›´åŠ pythonicã€‚</li><li>å¯ä»¥å¢åŠ è®¸å¤šé¢å¤–çš„å±æ€§ï¼Œæ›´å¥½çš„ç®¡ç†è£…é¥°å™¨å¯¹è±¡ã€‚</li><li>å¯ä»¥ç»™è£…é¥°å™¨æ·»åŠ æ›´å¤šçš„åŠŸèƒ½ã€‚</li></ol></blockquote><p>åŠŸèƒ½æ€ä¹ˆåŠ å‘¢ï¼Ÿåˆ«å¿˜äº†æˆ‘ä»¬ä¸Šä¸ªä»£ç æ®µè¿˜æœ‰ä¸€ä¸ªå‡½æ•°æ²¡æœ‰ä½¿ç”¨ï¼è¯ä¸å¤šè¯´ï¼Œç›´æ¥çœ‹çœ‹æ€ä¹ˆç”¨ã€‚<br>åŸå§‹ç”¨æ³•ï¼š</p><pre><code class="python">spider = MySpider(spider).at_once_run
spider()</code></pre><p>ä½†æ˜¯çœ‹èµ·æ¥å¹¶ä¸ä¼˜é›…ï¼Œæ¯æ¬¡ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚<br>è¯­æ³•ç³–ç”¨æ³•ï¼š</p><pre><code class="python">@MySpider
def spider():
    ...
spider.at_once_run()</code></pre><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>now, run the function
æ­£åœ¨æŠ“å–</code></pre><p>å°±åƒåŠ äº†é­”æ³•ä¸€æ ·ï¼Œæˆ‘ä»¬çš„åŸå§‹å‡½æ•°<code>spider</code>å˜å¾—å¼‚å¸¸å¼ºå¤§ï¼Œè¿˜å¢åŠ äº†è®¸å¤šæ–°çš„åŠŸèƒ½ï¼</p><p>å¥½äº†ï¼ŒæŠŠç±»å½“ä½œè£…é¥°å™¨çš„ç®€å•åŸç†å¦‚ä¸Šã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å±•ç¤ºä¸€ä¸‹ï¼Œç”¨ç±»è£…é¥°å™¨ä¸º<code>Session</code>å¯¹è±¡æ’ä¸Šç¿…è†€ï¼</p><h4 id="3-2-2-ç±»è£…é¥°å™¨å®æˆ˜"><a href="#3-2-2-ç±»è£…é¥°å™¨å®æˆ˜" class="headerlink" title="3.2.2 ç±»è£…é¥°å™¨å®æˆ˜"></a>3.2.2 ç±»è£…é¥°å™¨å®æˆ˜</h4><p>ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="python">class RequestsRetry:
    def __init__(self, max_retry: int, func: Callable) -&gt; None:
        &quot;&quot;&quot;éœ€è¦æ³¨æ„ã€‚è¢«è£…é¥°çš„å‡½æ•°æ˜¯æœ€åä¼ å…¥çš„ã€‚&quot;&quot;&quot;
        self.max_retry = max_retry
        functools.wraps(func)(self)  # ä¿ç•™åŸå‡½æ•°çš„å…ƒä¿¡æ¯
        self.func = func

    def __call__(self, *args, **kwargs) -&gt; BaseDictData:
        &quot;&quot;&quot;è£…é¥°å™¨å¤„ç†é€»è¾‘å‡½æ•°&quot;&quot;&quot;
        session: requests.Session = kwargs.get(&quot;session&quot;, requests.Session())  # è·å–session æˆ–è€…æ–°å»º session
        max_retry: requests.Session = kwargs.get(&quot;max_retry&quot;)  # è·å– max_retry
        adapter: HTTPAdapter = HTTPAdapter(max_retries=max_retry)  # åˆå§‹è‡ªå¸¦å¤„ç†é¢å¤–æ“ä½œçš„é€‚é…å™¨
        session.mount(&quot;http://&quot;, adapter=adapter)  # ç»™æˆ‘ä»¬çš„ session å®‰è£…ä¸Š adapter, ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‰ç¼€ï¼Œä»£è¡¨å“ªç§è¯·æ±‚éœ€è¦è£…ä¸Šé€‚é…å™¨
        kwargs.update(session=session)  # æ›´æ–° sessionï¼Œ å¦‚æœæ²¡æœ‰ä¼ sessionï¼Œå°±å°†å¸¦é€‚é…å™¨çš„ session ä¼ å…¥å‘½åå‚æ•°
        try:
            response: BaseDictData = self.func(*args, **kwargs)
        except requests.ConnectTimeout:
            print(f&quot;{max_retry}æ¬¡è¯·æ±‚éƒ½è¶…æ—¶äº†ï¼Œå³å°†è¿”å›ç©ºå€¼ï¼Œè¯·è€å¿ƒç­‰å¾…è¿”å›ç©ºå€¼&quot;)
            return {}
        else:
            return response

    def itself(self, *args, **kwargs) -&gt; BaseDictData:
        &quot;&quot;&quot;ä¸åšå¤„ç†ï¼Œè°ƒç”¨æœ¬èº«&quot;&quot;&quot;
        return self.func(*args, **kwargs)

    def __get__(self, instance, owner) -&gt; object:
        &quot;&quot;&quot;å®ç°è¯¥æ–¹æ³•åï¼Œå¯ä»¥å°†è£…é¥°å™¨å™¨ç”¨äºç±»çš„å‡½æ•°çš„è£…é¥°ã€‚&quot;&quot;&quot;
        if instance is None:
            return self
        return types.MethodType(self, instance)  # å¦‚æœæœ‰å‚æ•°ï¼Œå°±ç»‘å®šè‡³self


def retry(max_retry: int = 3):
    &quot;&quot;&quot;è£…é¥°å™¨åŒ…è£…ï¼Œå¢åŠ è¯·æ±‚é‡è¯•å‚æ•°ã€‚&quot;&quot;&quot;
    # æ­¤å¤„ä¸ºäº†é¿å…å®šä¹‰é¢å¤–å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨ functools.partial å¸®åŠ©æ„é€  RequestsRetry å®ä¾‹
    return functools.partial(RequestsRetry, max_retry)



@retry(max_retry=3)
def get_data(url: str, time_out: float = 3., **kwargs) -&gt; BaseDictData:
    --skip--</code></pre><p><code>__init__</code>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæ¥å—äº†ä¸€ä¸ªé¢å¤–å‚æ•°<code>max_retry</code>ï¼Œç„¶ååˆ©ç”¨<code>functools</code>ä¿ç•™<strong>å…ƒå‡½æ•°ä¿¡æ¯</strong>ï¼Œå’Œå‡½æ•°è£…é¥°å™¨ç±»ä¼¼ã€‚<br>ç„¶åæ ¸å¿ƒä»£ç ä¸º<code>__call__</code>ä¸­çš„éƒ¨åˆ†æˆ‘ä»¬åˆ©ç”¨<code>kwargs</code>è·å–ä¼ å…¥çš„<code>Session</code>å¯¹è±¡ï¼Œç„¶åå†å°†è¯¥å¯¹è±¡åŠ ä¸Š<strong>é€‚é…å™¨</strong>ï¼Œç„¶åè¿˜ç»™<code>kwargs</code>ï¼Œå³å¯ã€‚è¿™æ ·å°±åŠ ä¸Šäº†æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¹Ÿå°±è‡ªå¸¦é‡è¯•åŠŸèƒ½äº†ã€‚æ¯”<code>for...in...</code>æ›´åŠ ç®€å•ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œä½†æ˜¯ç¼ºç‚¹å°±æ˜¯åªèƒ½é’ˆå¯¹<code>Session</code>å¯¹è±¡çš„é”™è¯¯ï¼Œä¸èƒ½é’ˆå¯¹ä¸‡èƒ½é”™è¯¯è¿›è¡Œé‡è¯•ã€‚</p><p>æœ€å<code>retry</code>å‡½æ•°ï¼Œç”¨äº†ä¸€ä¸ª<code>partial</code>å‡½æ•°<strong>è¾…åŠ©æ„é€ </strong>ï¼ˆå¦‚æœä¸å®ç”¨è¯¥å‡½æ•°ï¼Œä¸ºè£…é¥°å™¨å¢åŠ <code>max_retry</code>å‚æ•°è¾ƒä¸ºéº»çƒ¦ï¼Œæ­¤å¤„ä¸å±•å¼€è¯´æ˜æ–¹æ³•ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å°è¯•ï¼Œæ¬¢è¿å’Œæˆ‘äº¤æµï¼‰ç±»è£…é¥°å™¨ï¼Œé¡ºä¾¿ç»™è£…é¥°å™¨æ¢äº†ä¸ªåå­—:)ã€‚</p><p>é¢å¤–çš„ä¸œè¥¿ï¼š</p><blockquote><p>æˆ‘ä»¬ä¸ºäº†ä¿ç•™å…ƒå‡½æ•°ï¼Œå¢åŠ äº†<code>itself</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯ä¸å¢åŠ é¢å¤–åŠŸèƒ½çš„è£…é¥°å™¨ï¼ˆ<strong>ä¿æŒåŸå‡½æ•°é€»è¾‘è°ƒç”¨</strong>ï¼‰ã€‚<br>æœ‰ä¸€ä¸ª<code>__get__</code>æ–¹æ³•ï¼Œå½“å®ä¾‹åŒ–å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå®è´¨å°±ä¼šå…ˆè°ƒç”¨è¯¥å‡½æ•°<strong>è·å–ç»‘å®šåœ¨å®ä¾‹åŒ–å¯¹è±¡ä¸Šçš„æ–¹æ³•</strong>ã€‚ç±»çš„è£…é¥°å™¨è£…é¥°å…¶ä»–ç±»ä¸­çš„å‡½æ•°æ—¶ï¼Œéœ€è¦è¡¥ä¸Šè¯¥æ–¹æ³•ï¼Œå¦åˆ™ç±»ä¸­çš„å‡½æ•°ä¸èƒ½ä½¿ç”¨è£…é¥°å™¨ã€‚æ­¤å¤„æˆ‘ä»¬åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œ<strong>é‡æ–°æ„é€ ç»‘å®šé€»è¾‘ã€‚</strong></p></blockquote><p>è¾“å‡ºç»“æœå’Œä¸Šæ–‡ä¸­çš„è¾“å‡ºä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸é‡å¤å±•ç¤ºç»“æœäº†ã€‚<br>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„æ‰€æœ‰é‡è¯•æ–¹æ³•å°±è®²è§£å®Œæ¯•å•¦ï¼Œç›¸ä¿¡ä½ ä¸€å®šä¹Ÿæ”¶è·æ»¡æ»¡ã€‚<br>è€è§„çŸ©ï¼Œæˆ‘ä»¬å†æ€»ç»“ä¸€ä¸‹æœ¬æ–‡æ‰€è®²å†…å®¹ï¼š</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><strong>1. <code>for...in...</code>å¾ªç¯å®ç°<code>requests</code>è¯·æ±‚é‡è¯•<br>2. åˆ©ç”¨<code>adapter</code> å®ç°<code>requests</code>è¯·æ±‚é‡è¯•<br>3. è£…é¥°å™¨å‡½æ•°åŸç†<br>4. åˆ©ç”¨å‡½æ•°è£…é¥°å™¨å®ç°<code>requests</code>è¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨<br>5. ç±»è£…é¥°å™¨ç®€å•åŸç†<br>6. ç±»è£…é¥°å™¨å®æˆ˜<code>requests</code>è¯·æ±‚é‡è¯•</strong></p><p><a href="https://github.com/Dustyposa/goSpider/tree/master/python_advance/requests%E8%AF%B7%E6%B1%82%E9%87%8D%E8%AF%95" target="_blank" rel="noopener">å®Œæ•´ä»£ç åœ°å€</a></p></div><hr><div><p><span><i class="iconfont icon-inbox"></i> <a class="hover-with-bg" href="/categories/advance/">advance</a> &nbsp; </span>&nbsp;&nbsp; <span><i class="iconfont icon-tag"></i> <a class="hover-with-bg" href="/tags/python/">python</a> <a class="hover-with-bg" href="/tags/decorator/">decorator</a></span></p><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0åè®®</a> ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext row"><div class="post-prev col-6"><a href="/2020/04/07/%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB(tr)/"><i class="fa fa-chevron-left"></i> <span class="hidden-mobile">å¼‚æ­¥ç½‘ç»œçˆ¬è™«</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></div><div class="post-next col-6"><a href="/2020/04/07/%E4%BD%BF%E7%94%A8python%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%9E%E4%BE%8B/"><span class="hidden-mobile">ä½¿ç”¨pythonå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åŠŸèƒ½æµ‹è¯•å®ä¾‹</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="fa fa-chevron-right"></i></a></div></div></div><div class="comments" id="comments"><script defer src="https://utteranc.es/client.js" repo="Dustyposa/utterances_comments" issue-term="pathname" label="âœ¨ğŸ’¬âœ¨" theme="github-light" crossorigin="anonymous"></script></div></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc-start"></div><div id="toc"><p class="h5"><i class="far fa-list-alt"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div></main><a class="z-depth-1" id="scroll-top-button" href="#" role="button"><i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><b>Fluid</b></a></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js"></script><script>$(document).ready(function(){var s=$("#navbar").height(),c=$("#toc"),t=$("#board-ctn"),o=t.offset().top,i=2*o+t.height();$(window).scroll(function(){var t=$("#toc-start").offset().top-s,o=document.body.scrollTop+document.documentElement.scrollTop;t<=o&&o<=i?c.css({display:"block",position:"fixed",top:s}):o<=t?c.css({position:"",top:""}):i<o&&c.css("display","none")}),tocbot.init({tocSelector:"#tocbot",contentSelector:".post-content",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,headingsOffset:-o}),0<$(".toc-list-item").length&&$("#toc > p").css("visibility","visible");var l=t.css("margin-right");$("#toc-ctn").css({right:l})})</script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js"></script><script>$(document).ready(function(){$("pre").addClass("prettyprint  "),prettyPrint()})</script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","ä»requestsè¯·æ±‚é‡è¯•åˆ°ä¸‡èƒ½é‡è¯•è£…é¥°å™¨&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){getSearchFile(path),this.onclick=null}</script><script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><script>$("#post img:not(.no-zoom img, img[no-zoom])").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script></body></html>